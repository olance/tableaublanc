<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8">

  <!-- Include Bulma CSS framework-->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.2/css/bulma.min.css">
  <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>

  <title>Tableau Blanc</title>
</head>

<body>
<section class="hero is-primary">
  <div class="hero-body">
    <div class="container">
      <h2 id="lesson-title" class="subtitle is-size-2"></h2>
      <h1 id="question-label" class="title is-size-1">Chargement de la question...</h1>
    </div>
  </div>
</section>

<label>Entre ta réponse pour l'envoyer sur le tableau blanc :</label>

<form id="answer-form">
  <p>
    <label for="author">Prénom :</label>
    <input type="text" name="author" id="author">
  </p>

  <p>
    <label for="answer">Réponse :</label>
    <input type="text" name="answer" id="answer">
  </p>

  <input type="submit" value="Envoyer">
</form>

<script src="https://www.gstatic.com/firebasejs/7.14.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.14.1/firebase-firestore.js"></script>

<script>
  //TODO : pourquoi la parenthèse ici ->(async ?
(async function() {
  // Your web app's Firebase configuration
  let firebaseConfig = {
    apiKey: "AIzaSyC3hhx5TOkre6obyCWd-0fGgSGrgQXqppU",
    authDomain: "tableaublanc-edfae.firebaseapp.com",
    databaseURL: "https://tableaublanc-edfae.firebaseio.com",
    projectId: "tableaublanc-edfae",
    storageBucket: "tableaublanc-edfae.appspot.com",
    messagingSenderId: "338342667367",
    appId: "1:338342667367:web:206957598b4de3311a20c2"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);

  let $form = document.querySelector("#answer-form");

  let match = location.search.match(/lessonid=([^&]+)/);
  if (!match || match[1].trim() === "") {
    alert("L'URL ne contient pas l'ID de cours");
    return;
  }

  const lessonId = match[1];
  let db = firebase.firestore();

  // Get lesson object to display its title
  let lessonDoc = await db.collection("lessons").doc(lessonId).get();
  // TODO : gros doute, on est d'accord cette fonction est interrompue tant que la réponse au-dessus n'est pas arrivée ?
  if (!lessonDoc.exists) {
    alert(`Le cours ${lessonId} n'existe pas !`);
    $form.querySelectorAll("input").forEach(el => el.disabled = true);
    return
  }

  let answers = db.collection("lessons").doc(lessonId).collection("answers");
  db.collection("lessons").doc(lessonId).collection("questions").where("current", "==", true).get().then(snapshot => {
    console.log(snapshot.size);
    snapshot.forEach(result =>{
      document.querySelector("#question-label").innerText = result.get("label");
      console.log(result.get("label"));
    })
  });

  document.querySelector("#lesson-title").innerText = lessonDoc.data().title;


  $form.addEventListener("submit", (event) => { // Fat-arrow function
    event.preventDefault();

    let author = document.querySelector("#author").value;
    let text = document.querySelector("#answer").value;
    let timestamp = Date.now();

      answers.add({ author, text,timestamp }).then(() => {
      document.querySelector("#answer").value = "";
    });

    return false
  })
})();
</script>
</body>
</html>