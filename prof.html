<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Tableau Blanc pour le prof</title>

  <!-- Include Bulma CSS framework-->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.2/css/bulma.min.css">
  <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>

  <!-- Include Handlebars from a CDN -->
  <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>

</head>

<body>
<!--Section de titre-->
<section class="hero is-primary">
  <div class="hero-body">
    <div class="container">
      <h1 id="lesson-title" class="title is-1"></h1>
      <h2 id="lesson-subtitle" class="subtitle is-2"></h2>
    </div>
  </div>
</section>

<!--Liste des messages reçus-->
<div id="answers" class="columns is-multiline">

</div>

<script src="https://www.gstatic.com/firebasejs/7.14.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.14.1/firebase-firestore.js"></script>

<script>
  function addZero(i) {
    if (i < 10) {
      i = "0" + i;
    }
    return i;
  }

  function dateFormat(ts) {
    var d = new Date(ts);
    var h = addZero(d.getHours());
    var m = addZero(d.getMinutes());
    var s = addZero(d.getSeconds());
    return h + ":" + m + ":" + s;
  }

  (async function() {
  // Your web app's Firebase configuration
  let firebaseConfig = {
    apiKey: "AIzaSyC3hhx5TOkre6obyCWd-0fGgSGrgQXqppU",
    authDomain: "tableaublanc-edfae.firebaseapp.com",
    databaseURL: "https://tableaublanc-edfae.firebaseio.com",
    projectId: "tableaublanc-edfae",
    storageBucket: "tableaublanc-edfae.appspot.com",
    messagingSenderId: "338342667367",
    appId: "1:338342667367:web:1c0129b1475444851a20c2"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  let db = firebase.firestore();

  // Get data once: https://firebase.google.com/docs/firestore/query-data/get-data?authuser=0
  // TODO: (DONE) Extraire lessonid et récupérer le titre du cours (voir index.html)
  let match = location.search.match(/lessonid=([^&]+)/);
  if (!match || match[1].trim() === "") {
    alert("L'URL ne contient pas l'ID de cours");
    return;
  }

  // Get lesson object to display its title
  const lessonId = match[1];
  let lessonDoc = await db.collection("lessons").doc(lessonId).get();

  if (!lessonDoc.exists) {
    alert(`Le cours ${lessonId} n'existe pas !`);
    $form.querySelectorAll("input").forEach(el => el.disabled = true);
    return
  }

  document.querySelector("#lesson-title").innerText = lessonDoc.data().title;
  document.querySelector("#lesson-subtitle").innerText = lessonId;

  let divTemplate = Handlebars.compile(document.querySelector("#div-template").innerHTML);

  // Listen for realtime updates: https://firebase.google.com/docs/firestore/query-data/listen?authuser=0
  db.collection("lessons").doc(lessonId).collection("answers").orderBy('timestamp').onSnapshot(answersDoc => {
    let items = answersDoc.docChanges().filter(c => c.type === "added").map(c => {
      let answer = c.doc.data();
      let div = document.createElement("div");
      div.setAttribute('class', 'column is-3');
      let time = dateFormat(answer.timestamp);

      div.innerHTML = divTemplate({ time, author: answer.author, text: answer.text });
      return div;
    });

    document.querySelector("#answers").append(...items);
  })

})()
</script>

<script id="div-template" type="text/x-handlebars-template">
  <div class="card">
    <div class="card-content">
      <h2 class="title">{{ text }}</h2>
    </div>
    <footer class="card-footer">
      <div class="card-footer-item">
        {{ author }}
      </div>
    </footer>
  </div>
</script>

</body>

</html>